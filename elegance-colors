#!/bin/bash
# Script to change the colors of Elegance Colors Gnome Shell theme
#
# Copyright (C) 2012  Satyajit sahoo
#
# Contains code for getting color from wallpaper by Matthew Richardson
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

# Set paths and variables
selfdir=`cd $(dirname "${BASH_SOURCE[0]}") && pwd`
selffile="$selfdir/elegance-colors"
configdir="$HOME/.config/elegance-colors"
configfile="$configdir/elegance-colors.ini"
tempdir="/tmp/elegance-colors"
installdir=`if [[ -d "gnome-shell" && -d "presets" ]]; then printf "$selfdir"; else printf "/usr/share/elegance-colors"; fi`
defaultconfig="$installdir/presets/default.ini"
template="$installdir/gnome-shell"
homedir=`awk -F: -v v="$(who | grep $(echo "$DISPLAY" | cut -d '.' -f 1) | cut -d ' ' -f 1 | tail -1)" '{if ($1==v) print $6}' /etc/passwd`
schemafile="org.gnome.shell.extensions.user-theme.gschema.xml"
schemadir="/usr/share/glib-2.0/schemas"
extensiondir="$homedir/.local/share/gnome-shell/extensions/user-theme@gnome-shell-extensions.gcampax.github.com/schemas"

show_info() {
echo -e "\033[0;32m[INFO $(date +"%H:%M:%S")]\033[0m $@"
}

show_warn() {
echo -e "\033[0;33m[WARN $(date +"%H:%M:%S")]\033[0m $@"
}

show_err() {
echo -e "\033[0;31m[ERR  $(date +"%H:%M:%S")]\033[0m $@" 1>&2
}

notify_err() {
show_err "$@"
notify-send -h int:transient:1 -i dialog-error "Elegance Colors" "$@"
}

fix_schema() {
if [[ $(whoami) = "root" ]]; then
	if [[ -f "$extensiondir/$schemafile" ]]; then
		cp "$extensiondir/$schemafile" "$schemadir/$schemafile"
		glib-compile-schemas "$schemadir"
	else
		show_err "Schema file could not be found. Is 'User themes' extension installed under '$homedir/.local/share/gnome-shell/extensions/'?"
		exit 1
	fi
else
	notify_err "Root access is needed to fix schema for 'User themes'!"
	exit 1
fi
}

export_theme() {
if [[ -f "$HOME/.themes/elegance-colors/gnome-shell/gnome-shell.css" ]]; then
	if [[ -z "$1" ]]; then
		read -p  "Enter a name for the theme: " themename
		themefile="$themename.zip"
		themepath="$HOME"
	else
		themefile="${1##*/}"
		themename="${themefile%*.zip}"
		themepath="${1%/*}"
	fi
	rm -rf "$tempdir/elegance-colors.tmp"
	mkdir -p "$tempdir/elegance-colors.tmp"
	cp -r "$HOME/.themes/elegance-colors" "$tempdir/elegance-colors.tmp/$themename"
	cd "$tempdir/elegance-colors.tmp"
	echo -e "Name: $themename for $(gnome-shell --version)\nGenerated by: elegance-colors <http://fav.me/d525x6c>\nLicense: GPL-3.0+" >> "$themename/README"
	zip -FS -qr "$themepath/$themefile" "$themename"
	rm -rf "$tempdir/elegance-colors.tmp"
	if [[ -f "$themepath/$themefile" ]]; then
		show_info "Theme exported to '$themepath/$themefile'"
		exit
	else
		notify_err "Failed to export theme!"
		exit 1
	fi
else
	notify_err "Theme files not found!"
	exit 1
fi
}

get_color() {
if [[ "$mode" = "gtk" ]]; then
	show_info "GTK theme found at '$gtkpath'"
	# Get the color values from the gtk.css file
	if [[ `grep "@define-color selected_bg_color #" "$gtkpath"` || `grep "@define-color selected_bg_color rgb" "$gtkpath"` ]]; then
		color=`grep "@define-color selected_bg_color" "$gtkpath" | sed -e "s/@define-color selected_bg_color //g" -e "s/;//g"`
	elif [[ `grep "@define-color theme_selected_bg_color #" "$gtkpath"` || `grep "@define-color theme_selected_bg_color rgb" "$gtkpath"` ]]; then
		color=`grep "@define-color theme_selected_bg_color" "$gtkpath" | sed -e "s/@define-color theme_selected_bg_color //g" -e "s/;//g"`
	fi
	if [[ `grep "@define-color selected_fg_color #" "$gtkpath"` || `grep "@define-color selected_fg_color rgb" "$gtkpath"` ]]; then
		text=`grep "@define-color selected_fg_color" "$gtkpath" | sed -e "s/@define-color selected_fg_color //g" -e "s/;//g"`
	elif [[ `grep "@define-color theme_selected_fg_color #" "$gtkpath"` || `grep "@define-color theme_selected_fg_color rgb" "$gtkpath"` ]]; then
		text=`grep "@define-color theme_selected_fg_color" "$gtkpath" | sed -e "s/@define-color theme_selected_fg_color //g" -e "s/;//g"`
	fi
elif [[ "$mode" = "wallpaper" ]]; then
	show_info "Wallpaper found at '$img'"
	# Scale background image to 3x3 and take the color from top-left
	color=`convert "$img" -brightness-contrast 15% -fuzz 15% -alpha off -filter cubic -resize 3x3 -transparent black -colorspace RGB -format '%[pixel:s]' info:-`
	bf=`convert "$img" -colorspace gray -format "%[fx:100*mean]" info:`
	bi="${bf/.*}"
	# Adjust text color according to the color brightness
	if [[ "$bi" -ge "60" ]]; then
		text="#000"
	else
		text="#fff"
	fi
elif [[ "$mode" =~ ^# || "$mode" =~ ^rgb ]]; then
	show_info "Using custom color"
	text="#fff"
	color="$mode"
fi
}

make_gradient() {
incolor="$1"
opacity="$2"
gradient="$3"
if [[ "$incolor" =~ ^# && "${#incolor}" -eq 4 ]]; then
	red2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 1`))
	green2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 2`))
	blue2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 3`))
elif [[ "$incolor" =~ ^# && "${#incolor}" -eq 7 ]]; then
	red2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 1`))
	green2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 2`))
	blue2=$((`echo "$incolor" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 3`))
elif [[ "$incolor" =~ ^rgb ]]; then
	red2=$(echo "$incolor" | sed -e 's/[a-z() ]//g' | cut -f1 -d\,)
	green2=$(echo "$incolor" | sed -e 's/[a-z() ]//g' | cut -f2 -d\,)
	blue2=$(echo "$incolor" | sed -e 's/[a-z() ]//g' | cut -f3 -d\,)
	opacity2=$(echo "$incolor" | sed -e 's/[a-z() ]//g' | cut -f4 -d\,)
else
	show_err "Invalid color '$incolor'"
fi
[[ "$opacity2" = "" ]] || opacity="$opacity2"
red1=$(( red2 + gradient ))
green1=$(( green2 + gradient ))
blue1=$(( blue2 + gradient ))
red3=$(( red2 - gradient ))
green3=$(( green2 - gradient ))
blue3=$(( blue2 - gradient ))
if [[ "$red1" -lt 255 && "$green1" -lt 255 && "$blue1" -lt 255 ]]; then
	color1="rgba($red1,$green1,$blue1,$opacity)"
	color2="rgba($red2,$green2,$blue2,$opacity)"
elif [[ "$red3" -gt 0 && "$green3" -gt 0 && "$blue3" -gt 0 ]]; then
	color1="rgba($red2,$green2,$blue2,$opacity)"
	color2="rgba($red3,$green3,$blue3,$opacity)"
else
	show_warn "Consider adjusting the color or gradient size"
	color1="rgba($red2,$green2,$blue2,$opacity)"
	color2="rgba($red2,$green2,$blue2,$opacity)"
fi
}

make_chameleon() {
color1="$1"
color2="$2"
amount="$3"
opacity="$4"
if [[ "$color1" =~ ^# && "${#color1}" -eq 4 ]]; then
	red1=$((`echo "$color1" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 1`))
	green1=$((`echo "$color1" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 2`))
	blue1=$((`echo "$color1" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 3`))
elif [[ "$color1" =~ ^# && "${#color1}" -eq 7 ]]; then
	red1=$((`echo "$color1" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 1`))
	green1=$((`echo "$color1" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 2`))
	blue1=$((`echo "$color1" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 3`))
elif [[ "$color1" =~ ^rgb ]]; then
	red1=$(echo "$color1" | sed -e 's/[a-z() ]//g' | cut -f1 -d\,)
	green1=$(echo "$color1" | sed -e 's/[a-z() ]//g' | cut -f2 -d\,)
	blue1=$(echo "$color1" | sed -e 's/[a-z() ]//g' | cut -f3 -d\,)
else
	show_err "Invalid color '$color1'"
fi
if [[ "$color2" =~ ^# && "${#color2}" -eq 4 ]]; then
	red2=$((`echo "$color2" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 1`))
	green2=$((`echo "$color2" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 2`))
	blue2=$((`echo "$color2" | sed -e 's/#//g' -e 's/./0x&&,/g' | cut -d ',' -f 3`))
elif [[ "$color2" =~ ^# && "${#color2}" -eq 7 ]]; then
	red2=$((`echo "$color2" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 1`))
	green2=$((`echo "$color2" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 2`))
	blue2=$((`echo "$color2" | sed -e 's/#//g' -e 's/../0x&,/g' | cut -d ',' -f 3`))
elif [[ "$color2" =~ ^rgb ]]; then
	red2=$(echo "$color2" | sed -e 's/[a-z() ]//g' | cut -f1 -d\,)
	green2=$(echo "$color2" | sed -e 's/[a-z() ]//g' | cut -f2 -d\,)
	blue2=$(echo "$color2" | sed -e 's/[a-z() ]//g' | cut -f3 -d\,)
else
	show_err "Invalid color '$color2'"
fi
red=$(( ( ( red1 * amount ) + ( red2 * 30 ) ) / ( amount + 30 ) ))
green=$(( ( ( green1 * amount ) + ( green2 * 30 ) ) / ( amount + 30 ) ))
blue=$(( ( ( blue1 * amount ) + ( blue2 * 30 ) ) / ( amount + 30 ) ))
chameleon="rgba($red,$green,$blue,$opacity)"
}

set_theme() {
# Initialize variables
SAVEIFS="$IFS"
IFS=''
unset vars vals
# General settings
get_color
make_gradient "$color" "1" "$selgradient"
custom_color1="$color1"
custom_color2="$color2"
fontfamily=$(echo "$fontname" | sed 's/\ \w*$//')
fontsize=$(echo "$fontname" | sed 's/.* //')
vars=(
	"${vars[@]}"
	"@custom_color1"
	"@custom_color2"
	"@text"
	"@fontfamily"
	"@fontsize"
	"@roundness"
	"@transition"
	"\/\*newbutton_$newbutton"
	"newbutton_$newbutton\*\/"
	"\/\*entry_$entry"
	"entry_$entry\*\/"
)
vals=(
	"${vals[@]}"
	"$custom_color1"
	"$custom_color2"
	"$text"
	"$fontfamily"
	"${fontsize}pt"
	"${roundness}px"
	"$transition"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
)
# Panel
make_gradient "$panel_bg" "$panel_opacity" "$panel_gradient"
panelbg1="$color1"
panelbg2="$color2"
make_gradient "$panel_bordercol" "$panel_borderop" "0"
panelborder="$color1"
make_chameleon "$color" "$panelbg1" "$panel_chameleon" "$panel_opacity"
panelbg1="$chameleon"
make_chameleon "$color" "$panelbg2" "$panel_chameleon" "$panel_opacity"
panelbg2="$chameleon"
vars=(
	"${vars[@]}"
	"@panelbg1"
	"@panelbg2"
	"@panel_fg"
	"@panelborder"
	"@panel_corner"
	"\/\*panelicon_$panel_icon"
	"panelicon_$panel_icon\*\/"
	"\/\*panelshadow_$panel_shadow"
	"panelshadow_$panel_shadow\*\/"
)
vals=(
	"${vals[@]}"
	"$panelbg1"
	"$panelbg2"
	"$panel_fg"
	"$panelborder"
	"${panel_corner}px"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
)
# Dash
make_gradient "$dash_bg" "$dash_opacity" "$dash_gradient"
dashbg1="$color1"
dashbg2="$color2"
make_gradient "$dash_bordercol" "$dash_borderop" "0"
dashborder="$color1"
make_chameleon "$color" "$dashbg1" "$dash_chameleon" "$dash_opacity"
dashbg1="$chameleon"
make_chameleon "$color" "$dashbg2" "$dash_chameleon" "$dash_opacity"
dashbg2="$chameleon"
# Generate message tray background
if [[ "$dash_opacity" = "0" ]]; then
	messagebg="transparent"
	messageborder="transparent"
else
	make_chameleon "$color" "$dash_bg" "$dash_chameleon" "0.1"
	messagebg="$chameleon"
	make_chameleon "$color" "$dashborder" "$dash_chameleon" "0.1"
	messageborder="$chameleon"
fi
dash_itemsize=$(( dash_iconsize + dash_iconspacing - 2 ))
vars=(
	"${vars[@]}"
	"@dash_fg"
	"@dashbg1"
	"@dashbg2"
	"@dashborder"
	"@dash_iconsize"
	"@dash_itemsize"
	"@dash_iconspacing"
	"@message-bg"
	"@message-border"
	"\/\*dashshadow_$dash_shadow"
	"dashshadow_$dash_shadow\*\/"
)
vals=(
	"${vals[@]}"
	"$dash_fg"
	"$dashbg1"
	"$dashbg2"
	"$dashborder"
	"${dash_iconsize}px"
	"${dash_itemsize}px"
	"${dash_iconspacing}px"
	"$messagebg"
	"$messageborder"
	"\/\*\*\/"
	"\/\*\*\/"
)
# Menu
make_gradient "$menu_bg" "$menu_opacity" "$menu_gradient"
menubg1="$color1"
menubg2="$color2"
make_gradient "$menu_bordercol" "$menu_borderop" "0"
menuborder="$color1"
make_chameleon "$color" "$menubg1" "$menu_chameleon" "$menu_opacity"
menubg1="$chameleon"
make_chameleon "$color" "$menubg2" "$menu_chameleon" "$menu_opacity"
menubg2="$chameleon"
vars=(
	"${vars[@]}"
	"@menubg1"
	"@menubg2"
	"@menu_fg"
	"@menuborder"
	"\/\*arrow_$menu_arrow"
	"arrow_$menu_arrow\*\/"
	"\/\*menushadow_$menu_shadow"
	"menushadow_$menu_shadow\*\/"
)
vals=(
	"${vals[@]}"
	"$menubg1"
	"$menubg2"
	"$menu_fg"
	"$menuborder"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
	"\/\*\*\/"
)
# Dialogs
make_gradient "$dialog_bg" "$dialog_opacity" "$dialog_gradient"
dialogbg1="$color1"
dialogbg2="$color2"
make_gradient "$dialog_bordercol" "$dialog_borderop" "0"
dialogborder="$color1"
make_chameleon "$color" "$dialogbg1" "$dialog_chameleon" "$dialog_opacity"
dialogbg1="$chameleon"
make_chameleon "$color" "$dialogbg2" "$dialog_chameleon" "$dialog_opacity"
dialogbg2="$chameleon"
vars=(
	"${vars[@]}"
	"@dialogbg1"
	"@dialogbg2"
	"@dialog_fg"
	"@dialog_heading"
	"@dialogborder"
	"\/\*dialogshadow_$dialog_shadow"
	"dialogshadow_$dialog_shadow\*\/"
)
vals=(
	"${vals[@]}"
	"$dialogbg1"
	"$dialogbg2"
	"$dialog_fg"
	"$dialog_heading"
	"$dialogborder"
	"\/\*\*\/"
	"\/\*\*\/"
)
# Set a temporary directory
makedir="$tempdir/elegance-colors-$(date +%H%M%S%N)"
# Copy Elegance Colors to create a new theme
if [[ -d "$template" ]]; then
	mkdir -p "$makedir"
	cp -rf "$template" "$makedir"
else
	show_err "Failed to copy files"
fi
# Replace variables in the template
show_info "Making the theme"
for (( i=0; i < ${#vars[@]}; i++ ))
do
	if [[ ! `grep "${vars[i]}" "$makedir/gnome-shell/gnome-shell.css"` ]]; then
		show_warn "Template does not have any ${vars[i]} variable"
	elif [[ "${vals[i]}" = "" ]]; then
		show_warn "The value of ${vars[i]} variable is not set"
	else
		show_info "Replacing ${vars[i]} with ${vals[i]}"
		sed -i "s/${vars[i]}/${vals[i]}/g" "$makedir/gnome-shell/gnome-shell.css"
	fi
done
# Copy the newly created theme
if [[ ! -d "$makedir/gnome-shell" ]]; then
	show_err "Failed to make the theme, files were lost"
elif [[ `grep "@" "$makedir/gnome-shell/gnome-shell.css"` ]]; then
	show_err "Failed to make the theme, could not replace variables"
	grep "@" "$makedir/gnome-shell/gnome-shell.css" | sort -u
elif [[ `grep ",," "$makedir/gnome-shell/gnome-shell.css"` ]]; then
	show_err "Failed to make the theme, invalid color expression"
	grep ",," "$makedir/gnome-shell/gnome-shell.css" | sort -u
else
	rm -rf "$HOME/.themes/elegance-colors"
	mkdir -p "$HOME/.themes/elegance-colors"
	mv "$makedir/gnome-shell" "$HOME/.themes/elegance-colors/"
	# Set the theme
	if [[ `gsettings get org.gnome.shell.extensions.user-theme name | grep -i "elegance-colors"` ]]; then
		show_info "Reloading the theme"
		gsettings set org.gnome.shell.extensions.user-theme name 'elegance-colors'
	fi
fi
# Remove the temporary directory
rm -rf "$makedir"
# Restore previous IFS
IFS="$SAVEIFS"
}

monitor_changes() {
# Check if config has been changed
md5conf="$tempdir/conf-md5"
md5c=`md5sum "$configfile"`
if [[ -f "$md5conf" ]]; then
	oldmd5c=`cat "$md5conf"`
	if [[ ! "$oldmd5c" = "$md5c" ]]; then
		show_info "Configuration change detected"
		set_theme
	fi
fi
echo "$md5c" > "$md5conf"
# Check if the gtk theme has been changed
if [[ "$mode" = "gtk" ]]; then
	md5gtk="$tempdir/gtk-md5"
	md5g=`md5sum "$gtkpath"`
	if [[ -f "$md5gtk" ]]; then
		oldmd5g=`cat "$md5gtk"`
		if [[ ! "$oldmd5g" = "$md5g" ]]; then
			show_info "GTK theme change detected"
			set_theme
		fi
	fi
	echo "$md5g" > "$md5gtk"
# Check if the wallpaper has been changed
elif [[ "$mode" = "wallpaper" ]]; then
	md5bg="$tempdir/background-md5"
	md5b=`md5sum "$img"`
	if [[ -f "$md5bg" ]]; then
		oldmd5b=`cat "$md5bg"`
		if [[ ! "$oldmd5b" = "$md5b" ]]; then
			show_info "Wallpaper change detected"
			set_theme
		fi
	fi
	echo "$md5b" > "$md5bg"
fi
}

set_config() {
# Update the old config file to support new options
while IFS='= ' read var val; do
	# Escape comments
	[[ $var =~ ^# ]] && continue
	# Read the section header
	[[ $var =~ ^\[ ]] && section="$var"
	# Write the non-existent value into the config file
	[[ `grep "$var" "$configfile"` ]] || echo -e "\n$section\n$var=$val" >> "$configfile"
done < "$defaultconfig"
# Load the config file
while IFS='= ' read var val; do
	# Escape comments, section headers and empty values
	[[ $var =~ ^# || $var =~ ^\[ || ! $val ]] && continue
	# Workaround for locales which use "," instead of "."
	[[ "$val" =~ ^[0-9]+.[0-9]+$ ]] && val="${val//,/.}"
	# Escape "(", ")" and " " for safe use in eval
	[[ "$val" =~ \( ]] && val="${val//\(/\\(}"
	[[ "$val" =~ \) ]] && val="${val//\)/\\)}"
	[[ "$val" =~ \  ]] && val="${val//\ /\\ }"
	# Define variables
	eval "$var"="$val"
done < "$configfile"
}

initialize() {
# If config directory doesn't exist, create it
[[ -d "$configdir" ]] || mkdir -p "$configdir"
# If config file doesn't exist, copy the default one
[[ -f "$configfile" ]] || cp -f "$defaultconfig" "$configfile"
# Create the temporary directory
[[ -d "$tempdir" ]] || mkdir -p "$tempdir"
# Get the gtk theme name
themename=$(gsettings get org.gnome.desktop.interface gtk-theme)
gtktheme="${themename//\'/}"
theme="${gtktheme//%/\\x}"
# Get the gtk theme path
if [[ -f "$HOME/.themes/$theme/gtk-3.0/gtk-main.css" ]]; then
	gtkpath="$HOME/.themes/$theme/gtk-3.0/gtk-main.css"
elif [[ -f "$HOME/.themes/$theme/gtk-3.0/gtk.css" ]]; then
	gtkpath="$HOME/.themes/$theme/gtk-3.0/gtk.css"
elif [[ -f "/usr/share/themes/$theme/gtk-3.0/gtk-main.css" ]]; then
	gtkpath="/usr/share/themes/$theme/gtk-3.0/gtk-main.css"
elif [[ -f "/usr/share/themes/$theme/gtk-3.0/gtk.css" ]]; then
	gtkpath="/usr/share/themes/$theme/gtk-3.0/gtk.css"
fi
# Get the background image path
path=$(gsettings get org.gnome.desktop.background picture-uri)
bg=$(echo "$path" | sed -e "s/'//g" -e "s/file:\/\///g")
img="${bg//%/\\x}"
# See if the returned image is a xml file
if [[ "$img" =~ .xml$ ]]; then
	img=$(grep "<file>" "$img" | grep ".jpg\|.png" | sed -e 's/<file>//' -e 's/<\/file>//' | head -n 1)
fi
# If elegance-colors doesn't exist in ~./themes, create it
if [[ ! -f "$HOME/.themes/elegance-colors/gnome-shell/gnome-shell.css" ]]; then
	set_config
	set_theme
fi
# Enable or disable autostart
if [[ "$monitor" = "false" && ! -f "$HOME/.config/autostart/elegance-colors-process.desktop" ]]; then
	show_info "Disabling autostart"
	cp -f "/etc/xdg/autostart/elegance-colors-process.desktop" "$HOME/.config/autostart/elegance-colors-process.desktop"
	echo "X-GNOME-Autostart-enabled=false" >> "$HOME/.config/autostart/elegance-colors-process.desktop"
elif [[ "$monitor" = "true" && -f "$HOME/.config/autostart/elegance-colors-process.desktop" ]]; then
	show_info "Enabling autostart"
	rm -f "$HOME/.config/autostart/elegance-colors-process.desktop"
fi
}

stop_process() {
if [[ -f "$tempdir/elegance-colors.pid" ]]; then
	pid=$(cat "$tempdir/elegance-colors.pid")
	rm -f "$tempdir/elegance-colors.pid"
	if [[ `grep -s elegance-colors "/proc/$pid/cmdline"` ]]; then
		kill -9 "$pid"
		show_info "Killed process $pid"
	else
		show_warn "$pid does not seem to be elegance-colors"
	fi
else
	show_warn "No running process found"
fi
}

run_process() {
show_info "Starting process"
# Delete old md5
md5self="$tempdir/self-md5"
rm -f "$md5self"
# Stop any previous instances first
[[ -f "$tempdir/elegance-colors.pid" ]] && stop_process
# Write the pid to a file
echo "$$" > "$tempdir/elegance-colors.pid"
while true; do
	# Don't run as root
	if [[ $(whoami) = "root" ]]; then
		show_err "Cannot run process as root"
		exit 1
	fi
	# Check if the script has been changed
	md5s=`md5sum "$selffile"`
	if [[ -f "$md5self" ]]; then
		oldmd5s=`cat "$md5self"`
		if [[ ! "$oldmd5s" = "$md5s" ]]; then
			show_info "Script has been changed, restarting..."
			$0 "$@" &
			exit 0
		fi
	fi
	md5sum "$selffile" > "$md5self"
	# No need to run in background if Gnome Shell is not running
	if ( [ ! "$(pidof gnome-shell)" ] ); then
		show_err "Gnome Shell not running"
		exit 1
	fi
	# Verify if schema file exists
	if [[ ! -f "$schemadir/$schemafile" ]]; then
		notify_err "Schema for 'User themes' could not be found, Run 'elegance-colors fix' as root to fix the problem"
		while [[ ! -f "$schemadir/$schemafile" ]]; do
			sleep 5
		done
	fi
	initialize
	set_config
	# Check if the current theme name matches elegance-colors
	if [[ `gsettings get org.gnome.shell.extensions.user-theme name | grep -i "elegance-colors"` ]]; then
		monitor_changes
	fi
	sleep 5
done
}

apply_changes() {
initialize
set_config
set_theme
}

case "$1" in
	"start")
		run_process;;
	"stop")
		stop_process;;
	"apply")
		apply_changes;;
	"gui")
		$selfdir/elegance-colors-gui;;
	"export")
		export_theme "$2";;
	"fix")
		fix_schema;;
	"help")
		man elegance-colors;;
	*)
		exec "$0" start > /dev/null 2>&1 &
		disown;;
esac
